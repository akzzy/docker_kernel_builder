name: CI

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Print start
        run: echo "Start build: $(date -u)"

      - name: Prepare clang (extract + create binutils symlinks)
        env:
          OTHER_CLANG_URL: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r536225.tar.gz
        run: |
          set -euo pipefail
          echo "Preparing clang toolchain in /home/runner/clang ..."

          # make directories
          rm -rf /home/runner/clang
          mkdir -p /home/runner/clang
          mkdir -p /home/runner/clang_tmp
          cd /home/runner/clang_tmp

          # download clang tarball (same url you used)
          echo "Downloading $OTHER_CLANG_URL ..."
          curl -L --retry 5 -o clang.tar.gz "$OTHER_CLANG_URL"

          # extract (tar autodetect)
          echo "Extracting clang tarball..."
          tar -xf clang.tar.gz

          # find the extracted root (there's usually a top-level dir)
          EXTRACT_DIR=$(find . -maxdepth 2 -type d -not -path . | sed -n '1p')
          if [ -z "$EXTRACT_DIR" ]; then
            # fallback: assume files are at current dir
            EXTRACT_DIR="."
          fi
          echo "extracted dir: $EXTRACT_DIR"

          # copy whole tree into /home/runner/clang
          cp -a "$EXTRACT_DIR"/. /home/runner/clang/

          # ensure bin exists
          mkdir -p /home/runner/clang/bin

          # if lld exists, create cross-linker symlinks pointing to lld
          if [ -x /home/runner/clang/bin/lld ]; then
            echo "Found lld at /home/runner/clang/bin/lld; creating symlinks..."
            cd /home/runner/clang/bin
            # create common linker names the action may expect
            ln -sf lld ld
            ln -sf lld ld.lld
            ln -sf lld aarch64-linux-android-ld
            ln -sf lld aarch64-linux-gnu-ld
            ln -sf lld arm-linux-androideabi-ld
            # other helpful names
            ln -sf lld ld64.lld || true
          else
            echo "Warning: lld not found in extracted clang bin. Listing /home/runner/clang/bin:"
            ls -la /home/runner/clang/bin || true
            exit 1
          fi

          # Make sure tools are executable
          chmod -R a+rx /home/runner/clang/bin || true

          # expose to PATH for later steps
          echo "PATH=/home/runner/clang/bin:$PATH" >> $GITHUB_ENV
          echo "Prepared /home/runner/clang with symlinks:"
          ls -la /home/runner/clang/bin | sed -n '1,200p'

      - name: Show toolchain quick check
        run: |
          echo "which clang: $(which clang || true)"
          echo "clang --version:"
          clang --version | sed -n '1,3p' || true
          echo "which ld: $(which ld || true)"
          echo "ld --version 2>/dev/null | sed -n '1,2p' || true"
          echo "ls /home/runner/clang/bin | sed -n '1,200p'"

      - name: Build kernel (dabao1955 action)
        uses: dabao1955/kernel_build_action@main
        with:
          kernel-url: https://github.com/akzzy/android_kernel_xiaomi_sdm845_docker
          kernel-branch: 16.0-KSU-Next
          config: beryllium_defconfig
          arch: arm64

          # keep AOSP toolchains disabled (we prepared clang locally)
          aosp-gcc: false
          aosp-clang: false

          # keep the original other-clang-url for clarity (action may ignore since we prepared /home/runner/clang)
          other-clang-url: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r536225.tar.gz

          android-version: 15
          ccache: true
          anykernel3: true
          release: true
          access-token: ${{ secrets.GITHUB_TOKEN }}
